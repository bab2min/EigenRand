name: Pull Request Test (non-x64)

on: 
  pull_request:
    branches: 
      - main

jobs:
  build_macos_aarch64:
    name: Build for macOS aarch64
    if: "!contains(github.event.head_commit.message, '[skip macos-aarch64]')"
    runs-on: macOS-latest
    continue-on-error: true
    strategy:
      max-parallel: 4
      matrix:
        arch: [DEIGEN_DONT_VECTORIZE, march=armv8-a+simd]
        eigenversion: [3.3.5, 3.3.6, 3.3.7, 3.3.8, 3.3.9, 3.4.0, 5.0.0]
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: Install dependencies
      run: |
        wget https://gitlab.com/libeigen/eigen/-/archive/${{ matrix.eigenversion }}/eigen-${{ matrix.eigenversion }}.tar.gz
        tar -zxvf eigen-${{ matrix.eigenversion }}.tar.gz
        mv eigen-${{ matrix.eigenversion }} include
    - name: Set C++ standard for Eigen 5.x
      id: cxx_standard
      run: |
        if [[ "${{ matrix.eigenversion }}" == 5.* ]]; then
          echo "cxx_standard=14" >> $GITHUB_OUTPUT
        else
          echo "cxx_standard=11" >> $GITHUB_OUTPUT
        fi
    - name: Build
      run: |
        export EIGEN_PATH=`pwd`/include
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_CXX_STANDARD=${{ steps.cxx_standard.outputs.cxx_standard }} -DEIGENRAND_CXX_FLAGS="-${{ matrix.arch }} -I${EIGEN_PATH}" ../
        make
    - name: Test
      run: |
        cd build
        ctest -R test --output-on-failure
    - name: Run Accuracy
      run: |
        cd build
        ctest -R accuracy --output-on-failure

  build-arm64:
    name: Build for Ubuntu 24 (Arm64)
    if: "!contains(github.event.head_commit.message, '[skip arm64]')"
    runs-on: ubuntu-24.04-arm
    continue-on-error: true
    strategy:
      max-parallel: 4
      matrix:
        arch: [DEIGEN_DONT_VECTORIZE, march=armv8-a+simd]
        eigenversion: [3.3.4, 3.3.5, 3.3.6, 3.3.7, 3.3.8, 3.3.9, 3.4.0, 5.0.0]

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: Install dependencies
      run: |
        wget https://gitlab.com/libeigen/eigen/-/archive/${{ matrix.eigenversion }}/eigen-${{ matrix.eigenversion }}.tar.gz
        tar -zxvf eigen-${{ matrix.eigenversion }}.tar.gz
        mv eigen-${{ matrix.eigenversion }} include
    - name: Set C++ standard for Eigen 5.x
      id: cxx_standard
      run: |
        if [[ "${{ matrix.eigenversion }}" == 5.* ]]; then
          echo "cxx_standard=14" >> $GITHUB_OUTPUT
        else
          echo "cxx_standard=11" >> $GITHUB_OUTPUT
        fi
    - name: Build
      run: |
        export EIGEN_PATH=`pwd`/include
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_STANDARD=${{ steps.cxx_standard.outputs.cxx_standard }} -DEIGENRAND_CXX_FLAGS="-${{ matrix.arch }} -I${EIGEN_PATH}" ../
        make
    - name: Test
      run: |
        cd build
        ctest -R test --output-on-failure
    - name: Run Accuracy
      run: |
        cd build
        ctest -R accuracy --output-on-failure